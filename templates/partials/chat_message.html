<div class="flex flex-col gap-1 {{ 'items-end' if sender == 'user' else 'items-start' }}">
    <div
        class="max-w-[80%] rounded-2xl px-4 py-3 {{ 'bg-blue-600 text-white rounded-br-none' if sender == 'user' else 'bg-gray-100 text-gray-800 rounded-bl-none' }}">
        <div class="prose prose-sm {{ 'text-white' if sender == 'user' else 'text-gray-800' }}">
            {{ message | safe }}
        </div>
    </div>
    <span class="text-xs text-gray-400 px-1">{{ 'You' if sender == 'user' else 'Gemini' }}</span>
    
    {% if sender == 'bot' and source_nodes and is_local %}
    <div class="max-w-[80%] mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
        <div class="text-xs font-semibold text-blue-700 mb-2">ðŸ“š References:</div>
        <div class="space-y-1">
            {% for source in source_nodes %}
            <div class="text-xs text-blue-600">
                <span class="font-medium">{{ source.document }}</span>
                {% if source.score %}
                <span class="text-blue-500">(relevance: {{ "%.2f"|format(1 - source.score) }})</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
